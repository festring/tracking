using UnityEngine;
using UnityEngine.Video;
using Tobii.GameIntegration.Net;
using System.IO;
using System;

public class TobiiIntegrationExample : MonoBehaviour
{
    private bool _isApiInitialized = false;
    private GazePoint _gazePoint;
    public VideoPlayer videoPlayer; // ������ ����� VideoPlayer ������Ʈ
    private StreamWriter _csvWriter;

    void Start()
    {
        InitializeTobiiApi();

        // CSV ���� ���� (���ø����̼��� ������ ��ο� ����, ��� �߰�)
        string filePath = Path.Combine(Application.dataPath, "test data2.csv");
        _csvWriter = new StreamWriter(filePath, true);
        _csvWriter.WriteLine("Timestamp (Current Time), X, Y"); // CSV ���
        Debug.Log($"CSV file initialized at path: {filePath}");

        // ���� �÷��̾ null�� �ƴ� ��� ���� �غ� ����
        if (videoPlayer != null)
        {
            videoPlayer.prepareCompleted += OnVideoPrepared; // �غ� �Ϸ� �� ����� �޼��� ���
            videoPlayer.Prepare(); // ���� �غ� ����
        }
        else
        {
            Debug.LogWarning("VideoPlayer is not assigned.");
        }
    }

    private void InitializeTobiiApi()
    {
        try
        {
            // Tobii API �ʱ�ȭ �� Ʈ��Ŀ ����
            TobiiGameIntegrationApi.SetApplicationName("TobiiEyeTracking");
            TobiiGameIntegrationApi.PrelinkAll();
            TobiiGameIntegrationApi.TrackTracker("tobii-prp://IS5FF-100212145514");
            _isApiInitialized = true;
            Debug.Log("Tobii Game Integration API initialized successfully.");
        }
        catch (System.Exception ex)
        {
            Debug.LogError("Exception during Tobii API initialization: " + ex.Message);
        }
    }

    // ������ �غ�Ǿ��� �� ȣ��Ǵ� �޼���
    private void OnVideoPrepared(VideoPlayer vp)
    {
        videoPlayer.Play(); // ���� ��� ����
        Debug.Log("Video is now playing.");
    }

    void Update()
    {
        if (_isApiInitialized && videoPlayer != null && videoPlayer.isPlaying)
        {
            TobiiGameIntegrationApi.Update();

            // �ֽ� �ü� ��ǥ �����͸� �������� �õ�
            if (TobiiGameIntegrationApi.TryGetLatestGazePoint(out _gazePoint))
            {
                Debug.Log("-");

                // ��ǥ �����͸� CSV ���Ͽ� ���
                LogGazeDataToCsv(_gazePoint);
            }
            else
            {
                Debug.Log($"Gaze Point - X: {_gazePoint.X}, Y: {_gazePoint.Y}, Time: {_gazePoint.TimeStampMicroSeconds}");
            }
        }
        else if (!_isApiInitialized)
        {
            Debug.LogWarning("Tobii API is not initialized.");
        }
        else if (videoPlayer != null && !videoPlayer.isPlaying)
        {
            Debug.Log("Video is not playing; gaze data is not recorded.");
        }
    }

    // CSV ���Ͽ� �α� ���
    private void LogGazeDataToCsv(GazePoint gazePoint)
    {
        if (_csvWriter != null)
        {
            // ���� �ý��� �ð��� DateTime.Now�� ���
            DateTime currentTime = DateTime.Now;

            // ��, ��, ��, �и��ʸ� 4�ڸ��� ����
            string formattedTime = currentTime.ToString("HH:mm:ss.ffff");

            // �α� ���ڿ� �ۼ�
            string log = $"{formattedTime}, {gazePoint.X}, {gazePoint.Y}";
            _csvWriter.WriteLine(log);
        }
    }

    // API �� ���� ���� ó��
    void OnDestroy()
    {
        if (_isApiInitialized)
        {
            TobiiGameIntegrationApi.Shutdown();
            Debug.Log("Tobii Game Integration API shut down.");
        }

        // ���� �ݱ�
        if (_csvWriter != null)
        {
            _csvWriter.Close();
            Debug.Log("Gaze data CSV file saved and closed.");
        }
    }
}
